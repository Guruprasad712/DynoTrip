# Substitutions - these can be overridden when triggering the build
substitutions:
  _REGION: us-central1
  _AR_REPO: dynotrip
  _API_SERVICE: dynotrip-api
  _MCP_SERVICE: dynotrip-mcp

options:
  logging: CLOUD_LOGGING_ONLY

steps:
  # Build MCP Service
  - name: 'gcr.io/cloud-builders/docker'
    args: ['build', '-t', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MCP_SERVICE}:$COMMIT_SHA', '-f', 'backend/Dockerfile.mcp', '.']
    id: 'build-mcp'

  # Push MCP Image
  - name: 'gcr.io/cloud-builders/docker'
    args: ['push', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MCP_SERVICE}:$COMMIT_SHA']

  # Deploy MCP Service
  - name: 'gcr.io/cloud-builders/gcloud'
    args: [
      'run', 'deploy', '${_MCP_SERVICE}',
      '--image', '${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_MCP_SERVICE}:$COMMIT_SHA',
      '--region', '${_REGION}',
      '--allow-unauthenticated',
      '--platform', 'managed',
      '--port', '8080',
      '--set-secrets', 'GOOGLE_MAPS_API_KEY=GOOGLE_MAPS_API_KEY:latest',
      '--update-secrets', '/secrets/gcp-credentials.json=GOOGLE_APPLICATION_CREDENTIALS:latest',
      '--update-env-vars', 'GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-credentials.json'
    ]

  # Get MCP Service URL and deploy API in one step to avoid substitution issues
  - name: 'gcr.io/cloud-builders/gcloud'
    id: 'deploy-api'
    entrypoint: 'bash'
    args:
      - '-c'
      - |
        # Get MCP Service URL
        MCP_URL=$(gcloud run services describe ${_MCP_SERVICE} --region ${_REGION} --format 'value(status.url)')
        echo "MCP Service URL: $MCP_URL"
        
        # Build API Service
        docker build -t ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_SERVICE}:$COMMIT_SHA \
          -f backend/Dockerfile.api \
          --build-arg GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-credentials.json \
          .
        
        # Push API Image
        docker push ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_SERVICE}:$COMMIT_SHA
        
        # Deploy API Service with MCP URL
        gcloud run deploy ${_API_SERVICE} \
          --image ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_AR_REPO}/${_API_SERVICE}:$COMMIT_SHA \
          --region ${_REGION} \
          --allow-unauthenticated \
          --platform managed \
          --port 8080 \
          --set-secrets GEMINI_API_KEY=GEMINI_API_KEY:latest,VERTEX_API_KEY=VERTEX_API_KEY:latest,PROJECT_ID=PROJECT_ID:latest,VERTEX_AI_MODEL=VERTEX_AI_MODEL:latest \
          --update-secrets /secrets/gcp-credentials.json=GOOGLE_APPLICATION_CREDENTIALS:latest \
          --update-env-vars "MCP_SERVER_URL=$MCP_URL,VERTEX_AI_LOCATION=${_REGION},GOOGLE_APPLICATION_CREDENTIALS=/secrets/gcp-credentials.json"